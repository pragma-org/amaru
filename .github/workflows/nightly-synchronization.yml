name: Nightly Sync

on:
  schedule:
    - cron: '00 08,22 * * *'

  workflow_dispatch:
    inputs:
      synchronization-level:
        description: 'Desired % synchronization level. Between 0 and 1.'
        required: false
        default: 1
        type: number

jobs:
  sync_and_cache:
    name: Synchronize (Haskell) cardano-node
    strategy:
      matrix:
        network: [ preprod, preview ]

    runs-on: ubuntu-latest

    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: auto
      ENDPOINT: ${{ secrets.S3_ENDPOINT }}
      OBJECT: "s3://${{ secrets.CARDANO_NODE_BUCKET_NAME }}/${{ matrix.network }}.tar.zstd"
      OGMIOS_VERSION: v6.14.0
      CARDANO_NODE_VERSION: 10.5.3

    steps:
      - name: üì• Download R2 Object
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "${{ runner.temp }}/db"
          aws s3 cp "$OBJECT" - --endpoint-url "$ENDPOINT" | tar --zstd -xf - -C "${{ runner.temp }}/db"
          touch ${{ runner.temp }}/db/clean

      - name: ‚öôÔ∏è Synchronize with ${{ matrix.network }}
        uses: CardanoSolutions/gh-action-cardano-node-ogmios-docker-sync@bdcd9c18c0e6bad2f43f38adaa409fae077ddae4
        with:
          db-dir: ${{ runner.temp }}/db
          network: ${{ matrix.network }}
          version: ${{ env.OGMIOS_VERSION }}_${{ env.CARDANO_NODE_VERSION }}
          synchronization-level: ${{ inputs.synchronization-level || 1 }}

      - name: üì• Upload R2 Object
        shell: bash
        run: |
          set -euo pipefail
          tar --zstd -cf - -C "${{ runner.temp }}/db" . | aws s3 cp - "$OBJECT" --endpoint-url "$ENDPOINT"
